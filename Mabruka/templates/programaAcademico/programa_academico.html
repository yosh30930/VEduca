{% extends "programaAcademico/base.html" %}
{% load static from staticfiles %}
{% block header %}
{{ block.super }}
<script type="text/javascript" src="{% static 'js/bootstrap-datetimepicker/bootstrap-datetimepicker.js' %}"></script>
<link href="{% static 'js/bootstrap-datetimepicker/bootstrap-datetimepicker.min.css' %}" rel='stylesheet' />
 <style type="text/css">
    #arbol-actividades li{
      background-color: rgba(0,0,0,0.01);
      padding: 0;
      padding-right: 0;
      border-right: 0;
      margin: 0;
    }
    #arbol-actividades {
      border-right: solid 1px #ddd;
    }
    #arbol-actividades ul div.dropdown {
      display: inline-block;
      float: right;
      margin: 2px;
      margin-top: 5px;
    }
    #arbol-actividades ul a.btn {
      float: right;
      margin: 2px;
    }
    .btns-actividades {
      display: inline-block;
      float: right;
    }
 </style>
{% endblock header %}

{% block breadcrums %}
  <li><a href="/inicio">Encuentros</a></li>
  <li class="active"><a href="./">Programa académico</a></li>
  <li></li>
{% endblock breadcrums %}

{% block content %}
{{ block.super }}
{% include "actividades/modals/encuentro.html" %}
{% include "actividades/modals/panel.html" %}
{% include "actividades/modals/seminario.html" %}
{% include "actividades/modals/foro.html" %}
<!-- Modal -->
<!-- Termina Modal -->
<div id="arbol-actividades"></div>

{# Assumes you setup the password_reset view in your URLconf #}
{# <p><a href="{% url 'password_reset' %}">Lost password?</a></p> #}
<script type="text/javascript">
$(function() {
    $('#arbol-actividades').tree({
        autoOpen: true,
        dataUrl:  function(node) {
            var data = {};
            var url = '';
            if(node){
                var tipo = node.tipo;
                var id = node.id;
                url = '/hijos/'+tipo+"/"+id+"/";
            }else{
              url = '/encuentros/'+{{encuentro_id}}+'/';
            }
            return {url: url, data: data};
       },
        dataFilter: function(data) {
            if (data['nombre']) {
              var nodo = data;
              nodo['label'] = nodo['nombre'] + " ";
              nodo['load_on_demand'] = true;
              return [nodo];
            }
            var nodos = [];
            $(data).each(function (index, obj) {
              var nombre_categoria = Object.keys(obj)[0];
              var nodo_categoria = {
                label: _.capitalize(nombre_categoria),
                children: []};
              $(obj[nombre_categoria]).each(function(index, nodo){
                //console.log('nodo', nodo);
                nodo['label'] = nodo['nombre'] + " ";
                nodo['load_on_demand'] = true;
                nodo_categoria['children'].push(nodo);
                //console.log('nodo', nodo);
              });
              //console.log(nodo_categoria['children'])
              nodos.push(nodo_categoria);
            });
            return nodos;
        },
        selectable: false,
        //closedIcon: '+',
        //openedIcon: '-',
        //autoOpen: true,
        onCreateLi: function (node, $li) {
            $li.addClass("list-group-item");
            $li.closest("ul").addClass("list-group");
            console.log($li.closest("ul"));
            if (node.tipo) {
              var botones = null;
              switch(node.tipo) {
                case "encuentro":
                  botones = set_botones_encuentro(node, $li);
                  break;
                case "foro":
                  botones = set_botones_foro(node, $li);
                  break;
                case "seminario":
                  botones = set_botones_seminario(node, $li);
                  break;
                case "panel":
                  botones = set_botones_panel(node, $li);
                  break;
              };
              if (botones != null) {
                $li.find(".jqtree-element").prepend(botones);
                $li.find(".jqtree-element").append($("<div style=clear:both></div>"));
              }
            };
        }
    });
  $("#arbol-actividades").on('click', ".btn-agregar",function(event){
    var $arbol = $('#arbol-actividades');
    var tipo = $(this).data("padre-tipo");
    console.log(tipo);
    //Obtenemos el tipo de objeto asociado al botón
    switch(tipo){
      case 'encuentro':
        $('#modalForo').modal('show');
        break;
      case 'foro':
        $('#modalSeminario').modal('show');
        break;
      case 'seminario':
        $('#modalPanel').modal('show');
        break;

    }
    //Mostramos algún modal asociado a algún hijo del tipo
  });
  $(document).on('actividadCreada', function(){
      $("#arbol-actividades").tree('reload');
  });
});

function set_botones_encuentro(node, $li) {
  var permisos = node.permisos_edicion;
  var btns_actividades = $("<div>", {class: "btns-actividades"});
  if ($.inArray('agregar hijos', permisos) > -1) {
    var drop_agregar = $.parseHTML(
    '<div class="dropdown">' +
      '<button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">' +
        'Agregar una actividad' +
        '<span class="caret"></span>' +
      '</button>' +
      '<ul class="dropdown-menu"></ul>'+
    '</div>'
    );
    var drop_menu = $(drop_agregar).find(".dropdown-menu");
    var li = $.parseHTML(
      '<li><a href="#" data-toggle="modal" data-target="#foro_modal" data-operacion="creacion" >Foro</a></li>');
    $(li).find("a").attr("data-id-actividad", node.id),
    $(li).find("a").attr("data-tipo-padre", node.tipo),
    $(drop_menu).append(li);
    var li = $.parseHTML(
      '<li><a href="#" data-toggle="modal" data-target="#plenaria_modal" data-operacion="creacion" >Plenaria</a></li>');
    $(li).find("a").attr("data-id-actividad", node.id),
    $(li).find("a").attr("data-tipo-padre", node.tipo),
    $(drop_menu).append(li);
    var li = $.parseHTML(
      '<li><a href="#" data-toggle="modal" data-target="#taller_modal" data-operacion="creacion" >Taller</a></li>');
    $(li).find("a").attr("data-id-actividad", node.id),
    $(li).find("a").attr("data-tipo-padre", node.tipo),
    $(drop_menu).append(li);
    $(btns_actividades).append(drop_agregar);
  }
  return btns_actividades;
};

function set_botones_foro(node, $li) {
  var permisos = node.permisos_edicion;
  var btns_actividades = $("<div>", {class: "btns-actividades"});
  if (($.inArray('editar como responsable', permisos) > -1) ||
      ($.inArray('editar como super responsable', permisos) > -1)) {
    var boton_editar = $("<a>",
      {text:"Editar foro",
      class:"btn btn-default btn-sm btn-editar",
      href: "#"
    });
    $(boton_editar).attr("data-toggle", "modal")
    $(boton_editar).attr("data-target", "#foro_modal")
    $(boton_editar).attr("data-operacion", "edicion")
    $(boton_editar).attr("data-id-actividad", node.id);
    $(btns_actividades).append(boton_editar);

  }

  if ($.inArray('eliminar', permisos) > -1) {
    var boton_eliminar = $("<a>",
      {text:"Eliminar foro",
      class:"btn btn-default btn-sm btn-editar",
      href: "#"
    });
    $(btns_actividades).append(boton_eliminar);
  }
  //$(boton_editar).attr("data-toggle", "modal")
  //$(boton_editar).attr("data-target", "#foro_modal")
  //$(boton_editar).attr("data-operacion", "edicion")
  //$(boton_editar).attr("data-id-actividad", node.id);
  if ($.inArray('agregar hijos', permisos) > -1) {
    $(btns_actividades).append($("<div style=clear:right></div>"));
    var boton_agregar = $("<a>",
      {text:"Agregar un seminario",
      class:"btn btn-default btn-sm btn-editar",
      href: "#"
    });
    $(boton_agregar).attr("data-toggle", "modal")
    $(boton_agregar).attr("data-target", "#seminario_modal")
    $(boton_agregar).attr("data-operacion", "creacion")
    $(boton_agregar).attr("data-id-actividad", node.id),
    $(boton_agregar).attr("data-tipo-padre", node.tipo),
    $(btns_actividades).append(boton_agregar);
  }
  return btns_actividades;
}

function set_botones_seminario(node, $li) {
  var permisos = node.permisos_edicion;
  var btns_actividades = $("<div>", {class: "btns-actividades"});
  if ($.inArray('eliminar', permisos) > -1) {
    var boton_eliminar = $("<a>",
      {text:"Eliminar seminario",
      class:"btn btn-default btn-sm btn-editar",
      href: "#"
    });
    $(btns_actividades).append(boton_eliminar);
  }

  if (($.inArray('editar como responsable', permisos) > -1) ||
      ($.inArray('editar como super responsable', permisos) > -1)) {
    var boton_editar = $("<a>",
      {text:"Editar seminario",
      class:"btn btn-default btn-sm btn-editar",
      href: "#"
    });
    $(boton_editar).attr("data-toggle", "modal")
    $(boton_editar).attr("data-target", "#seminario_modal")
    $(boton_editar).attr("data-operacion", "edicion")
    $(boton_editar).attr("data-id-actividad", node.id);
    $(btns_actividades).append(boton_editar);
  }


  if ($.inArray('agregar hijos', permisos) > -1) {
    $(btns_actividades).append($("<div style=clear:right></div>"));
    var drop_agregar = $.parseHTML(
    '<div class="dropdown">' +
      '<button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">' +
        'Agregar una actividad' +
        '<span class="caret"></span>' +
      '</button>' +
      '<ul class="dropdown-menu"></ul>'+
    '</div>'
    );
    var drop_menu = $(drop_agregar).find(".dropdown-menu");
    var li = $.parseHTML(
      '<li><a href="#" data-toggle="modal" data-target="#panel_modal" data-operacion="creacion" >Panel</a></li>');
    $(li).find("a").attr("data-id-actividad", node.id),
    $(li).find("a").attr("data-tipo-padre", node.tipo),
    $(drop_menu).append(li);
    var li = $.parseHTML(
      '<li><a href="#" data-toggle="modal" data-target="#mesa_redonda_modal" data-operacion="creacion" >Mesa redonda</a></li>');
    $(li).find("a").attr("data-id-actividad", node.id),
    $(li).find("a").attr("data-tipo-padre", node.tipo),
    $(drop_menu).append(li);
    var li = $.parseHTML(
      '<li><a href="#" data-toggle="modal" data-target="#ponencia_modal" data-operacion="creacion" >Ponencia</a></li>');
    $(li).find("a").attr("data-id-actividad", node.id),
    $(li).find("a").attr("data-tipo-padre", node.tipo),
    $(drop_menu).append(li);
    $(btns_actividades).append(drop_agregar);
  }
  return btns_actividades;
}

function set_botones_panel(node, $li) {
  var permisos = node.permisos_edicion;
  var btns_actividades = $("<div>", {class: "btns-actividades"});
  if ($.inArray('eliminar', permisos) > -1) {
    var boton_eliminar = $("<a>",
      {text:"Eliminar panel",
      class:"btn btn-default btn-sm btn-editar",
      href: "#"
    });
    $(btns_actividades).append(boton_eliminar);
  }

  var boton_editar = $("<a>",
    {text:"Editar panel",
    class:"btn btn-default btn-sm btn-editar",
    href: "#"
  });

  if (($.inArray('editar como responsable', permisos) > -1) ||
      ($.inArray('editar como super responsable', permisos) > -1)) {
    $(boton_editar).attr("data-toggle", "modal")
    $(boton_editar).attr("data-target", "#panel_modal")
    $(boton_editar).attr("data-operacion", "edicion")
    $(boton_editar).attr("data-id-actividad", node.id);
    $(btns_actividades).append(boton_editar);
  }
  return btns_actividades;
}

</script>
{% endblock content %}
